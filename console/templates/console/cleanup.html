{% extends "console/base.html" %}

{% block title %}Data Cleanup - Ops Console{% endblock %}

{% block console_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Data Cleanup</h1>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card text-bg-{% if summary.jobs_pending_cleanup > 0 %}warning{% else %}success{% endif %}">
      <div class="card-body">
        <h5 class="card-title">Jobs Pending Cleanup</h5>
        <p class="display-6 mb-1">{{ summary.jobs_pending_cleanup }}</p>
        <small>{{ summary.jobs_reclaimable_mb }} MB reclaimable</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-{% if summary.orphan_workdirs > 0 %}danger{% else %}success{% endif %}">
      <div class="card-body">
        <h5 class="card-title">Orphan Workdirs</h5>
        <p class="display-6 mb-1">{{ summary.orphan_workdirs }}</p>
        <small>{{ summary.orphan_workdirs_mb }} MB (no DB record)</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-{% if summary.orphan_jobs > 0 %}danger{% else %}success{% endif %}">
      <div class="card-body">
        <h5 class="card-title">Orphan Jobs</h5>
        <p class="display-6 mb-1">{{ summary.orphan_jobs }}</p>
        <small>DB records with missing files</small>
      </div>
    </div>
  </div>
</div>

<!-- Cleanup Actions -->
<div class="card mb-4">
  <div class="card-header">
    <strong>Run Cleanup</strong>
  </div>
  <div class="card-body">
    <form method="post" action="{% url 'console:run_cleanup' %}" class="row g-3">
      {% csrf_token %}
      <div class="col-md-4">
        <label for="override_days" class="form-label">Override Retention (days)</label>
        <input type="number" class="form-control" id="override_days" name="override_days" 
               placeholder="Leave blank to use per-user settings" min="1">
        <small class="text-muted">Optional: override per-user retention settings</small>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <div class="btn-group w-100">
          <button type="submit" name="dry_run" value="1" class="btn btn-outline-primary">
            Preview Cleanup
          </button>
          <button type="submit" name="dry_run" value="0" class="btn btn-danger"
                  onclick="return confirm('This will permanently delete job workdirs. Are you sure?');">
            Run Cleanup
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Jobs Pending Cleanup -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Jobs Past Retention Period</strong>
    <span class="badge bg-secondary">{{ jobs_for_cleanup|length }} shown</span>
  </div>
  <div class="card-body p-0">
    {% if jobs_for_cleanup %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Job ID</th>
            <th>Owner</th>
            <th>Completed</th>
            <th>Age</th>
            <th>Retention</th>
            <th>Workdir</th>
            <th>Size</th>
          </tr>
        </thead>
        <tbody>
          {% for item in jobs_for_cleanup %}
          <tr>
            <td>
              <a href="{% url 'console:job_detail' job_id=item.job.id %}">
                <code>{{ item.job.id|truncatechars:13 }}</code>
              </a>
            </td>
            <td>{{ item.job.owner.username }}</td>
            <td class="text-muted">{{ item.completed_at|date:"Y-m-d H:i" }}</td>
            <td>{{ item.age_days }} days</td>
            <td>{{ item.retention_days }} days</td>
            <td>
              {% if item.workdir_exists %}
              <span class="badge bg-warning text-dark">Exists</span>
              {% else %}
              <span class="badge bg-secondary">Missing</span>
              {% endif %}
            </td>
            <td class="text-muted">{{ item.workdir_size|filesizeformat }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="p-4 text-center text-muted">
      No jobs are past their retention period.
    </div>
    {% endif %}
  </div>
</div>

<!-- Orphan Workdirs -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Orphan Workdirs (No DB Record)</strong>
    {% if orphan_workdirs %}
    <form method="post" action="{% url 'console:delete_all_orphans' %}" class="d-inline">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger btn-sm"
              onclick="return confirm('Delete ALL orphan workdirs? This cannot be undone.');">
        Delete All Orphans
      </button>
    </form>
    {% endif %}
  </div>
  <div class="card-body p-0">
    {% if orphan_workdirs %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Directory Name</th>
            <th>Size</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for orphan in orphan_workdirs %}
          <tr>
            <td><code>{{ orphan.name }}</code></td>
            <td class="text-muted">{{ orphan.size|filesizeformat }}</td>
            <td>
              <form method="post" action="{% url 'console:delete_orphan' %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="path" value="{{ orphan.path }}">
                <button type="submit" class="btn btn-outline-danger btn-sm"
                        onclick="return confirm('Delete this orphan workdir?');">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="p-4 text-center text-muted">
      No orphan workdirs found.
    </div>
    {% endif %}
  </div>
</div>

<!-- Orphan Jobs -->
<div class="card mb-4">
  <div class="card-header">
    <strong>Orphan Jobs (Missing Workdir)</strong>
  </div>
  <div class="card-body p-0">
    {% if orphan_jobs %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Job ID</th>
            <th>Owner</th>
            <th>Status</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for job in orphan_jobs %}
          <tr>
            <td>
              <a href="{% url 'console:job_detail' job_id=job.id %}">
                <code>{{ job.id|truncatechars:13 }}</code>
              </a>
            </td>
            <td>{{ job.owner.username }}</td>
            <td><span class="fw-semibold status-{{ job.status }}">{{ job.status }}</span></td>
            <td class="text-muted">{{ job.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a href="{% url 'console:job_detail' job_id=job.id %}" class="btn btn-outline-secondary btn-sm">
                Review
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="p-4 text-center text-muted">
      No orphan jobs found.
    </div>
    {% endif %}
  </div>
</div>

<!-- CLI Reference -->
<div class="card">
  <div class="card-header">
    <strong>CLI Commands</strong>
  </div>
  <div class="card-body">
    <p class="text-muted">For automated cleanup, use these management commands:</p>
    <pre class="bg-body-secondary p-3 rounded mb-2">python manage.py cleanup_jobs --dry-run  # Preview cleanup
python manage.py cleanup_jobs            # Execute cleanup
python manage.py cleanup_jobs --days=60  # Override retention period</pre>
    <pre class="bg-body-secondary p-3 rounded">python manage.py detect_orphans          # Report orphans
python manage.py detect_orphans --fix    # Delete orphan workdirs</pre>
  </div>
</div>
{% endblock %}

