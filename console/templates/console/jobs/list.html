{% extends "console/base.html" %}

{% block title %}Jobs - Ops Console{% endblock %}

{% block console_content %}
<style>
  /* Subtle background for hidden job rows - adapts to light/dark mode */
  .row-hidden {
    background-color: rgba(var(--bs-secondary-rgb), 0.08) !important;
  }
  .row-hidden:hover {
    background-color: rgba(var(--bs-secondary-rgb), 0.15) !important;
  }
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Jobs</h1>
  <span class="badge bg-secondary fs-6">{{ jobs|length }} shown</span>
</div>

<!-- Search and Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label for="search" class="form-label">Search</label>
        <input type="text" class="form-control" id="search" name="search" value="{{ search }}" 
               placeholder="Job ID, name, owner, SLURM ID&#x2026;">
      </div>
      <div class="col-md-2">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status" name="status">
          <option value="">All</option>
          {% for value, label in statuses %}
          <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="runner" class="form-label">Runner</label>
        <select class="form-select" id="runner" name="runner">
          <option value="">All</option>
          {% for r in runners %}
          <option value="{{ r }}" {% if runner == r %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="hidden" class="form-label">Hidden</label>
        <select class="form-select" id="hidden" name="hidden">
          <option value="">All</option>
          <option value="no" {% if hidden == "no" %}selected{% endif %}>Visible</option>
          <option value="yes" {% if hidden == "yes" %}selected{% endif %}>Hidden</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Bulk Actions Form -->
<form method="post" action="{% url 'console:job_bulk_action' %}" id="bulk-form">
  {% csrf_token %}
  
  <!-- Bulk Action Bar -->
  <div class="card mb-3" id="bulk-action-bar" style="display: none;">
    <div class="card-body py-2 d-flex justify-content-between align-items-center">
      <span><span id="selected-count">0</span> job(s) selected</span>
      <div class="btn-group">
        <button type="submit" name="action" value="cancel" class="btn btn-outline-danger btn-sm"
                onclick="return confirm('Cancel selected jobs?');">
          Cancel Selected
        </button>
        <button type="submit" name="action" value="hide" class="btn btn-outline-warning btn-sm"
                onclick="return confirm('Hide selected jobs from their owners?');">
          Hide from Owners
        </button>
      </div>
    </div>
  </div>

  <!-- Jobs Table -->
  <div class="card">
    <div class="card-body p-0">
      {% if jobs %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" class="form-check-input" id="select-all">
              </th>
              <th>Job ID</th>
              <th>Name</th>
              <th>Owner</th>
              <th>Runner</th>
              <th>Status</th>
              <th>SLURM ID</th>
              <th>Created</th>
              <th>Hidden</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for job in jobs %}
            <tr class="{% if job.hidden_from_owner %}row-hidden{% endif %}">
              <td>
                <input type="checkbox" class="form-check-input job-checkbox" name="job_ids" value="{{ job.id }}">
              </td>
              <td>
                <a href="{% url 'console:job_detail' job_id=job.id %}">
                  <code>{{ job.id|truncatechars:13 }}</code>
                </a>
              </td>
              <td>{{ job.name|default:"-" }}</td>
              <td>{{ job.owner.username }}</td>
              <td><span class="badge bg-secondary">{{ job.runner }}</span></td>
              <td><span class="fw-semibold status-{{ job.status }}">{{ job.status }}</span></td>
              <td><code class="text-muted">{{ job.slurm_job_id|default:"-" }}</code></td>
              <td class="text-muted">{{ job.created_at|date:"Y-m-d H:i" }}</td>
              <td>
                {% if job.hidden_from_owner %}
                <span class="badge bg-warning">Hidden</span>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'console:job_detail' job_id=job.id %}" class="btn btn-outline-secondary btn-sm">
                  View
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-4 text-center text-muted">
        No jobs found matching your criteria.
      </div>
      {% endif %}
    </div>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.job-checkbox');
  const bulkActionBar = document.getElementById('bulk-action-bar');
  const selectedCount = document.getElementById('selected-count');
  
  function updateBulkActionBar() {
    const checked = document.querySelectorAll('.job-checkbox:checked').length;
    selectedCount.textContent = checked;
    bulkActionBar.style.display = checked > 0 ? 'block' : 'none';
  }
  
  selectAll.addEventListener('change', function() {
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkActionBar();
  });
  
  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateBulkActionBar);
  });
});
</script>
{% endblock %}

